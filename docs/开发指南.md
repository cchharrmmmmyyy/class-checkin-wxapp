# 微信小程序打卡系统 - 开发指南

## 1. 项目概述

微信小程序打卡系统是一个基于微信小程序和Flask后端的轻量级打卡管理系统，支持学生打卡、教师管理和班长统计等功能。本项目采用模块化设计，便于二次开发和功能扩展。

## 2. 技术栈

### 2.1 前端技术栈
- 微信小程序原生开发
- JavaScript
- WXML/WXSS

### 2.2 后端技术栈
- Python 3.13
- Flask 框架
- SQLite 数据库

### 2.3 数据存储
- SQLite关系型数据库：存储打卡记录和用户信息

## 3. 项目结构

```
.
├── README.md                # 项目说明文档
├── backend/                 # 后端代码目录
│   ├── app.py               # Flask 应用入口
│   ├── database.py          # 数据库操作模块
│   ├── student.py           # 学生相关业务逻辑
│   ├── teacher.py           # 教师相关业务逻辑
│   └── admin.py             # 管理员相关业务逻辑
├── admin.html             # 管理员Web管理界面
├── docs/                    # 文档目录
│   ├── API文档.md          # API接口文档
│   ├── 开发指南.md        # 开发指南文档
│   └── readme.md           # 文档说明
└── miniprogram/             # 微信小程序前端目录
    ├── app.js               # 小程序入口文件
    ├── app.json             # 小程序全局配置
    ├── app.wxss             # 小程序全局样式
    ├── pages/               # 页面目录
    │   ├── login/           # 登录页面
    │   ├── student/         # 学生相关页面
    │   │   ├── leave-apply.js        # 请假申请页面
    │   │   ├── leave-apply.json      # 请假申请页面配置
    │   │   ├── leave-apply.wxml      # 请假申请页面结构
    │   │   ├── leave-apply.wxss      # 请假申请页面样式
    │   │   ├── leave-records.js      # 请假记录页面
    │   │   ├── leave-records.json    # 请假记录页面配置
    │   │   ├── leave-records.wxml    # 请假记录页面结构
    │   │   ├── leave-records.wxss    # 请假记录页面样式
    │   │   ├── student-detail.js     # 学生详情页面
    │   │   ├── student-detail.json   # 学生详情样式
    │   │   ├── student.js            # 学生主页面
    │   │   ├── student.json          # 学生页面配置
    │   │   ├── student.wxml          # 学生页面结构
    │   │   └── student.wxss          # 学生页面样式
    │   └── teacher/         # 教师相关页面
    │       ├── teacher.js          # 教师主页面
    │       ├── teacher.json        # 教师页面配置
    │       ├── teacher.wxml        # 教师页面结构
    │       └── teacher.wxss        # 教师页面样式
    └── utils/               # 工具函数目录
        └── auth.js          # 登录验证工具
```

## 4. 开发环境搭建

### 4.1 后端环境
1. 安装 Python 3.13
2. 安装依赖：`pip install flask`
3. 运行后端：`python app.py`

### 4.2 前端环境
1. 安装微信开发者工具
2. 导入 miniprogram 目录
3. 配置小程序 AppID

## 5. 二次开发指南

### 5.1 数据库扩展

#### 5.1.1 添加新表
在 `database.py` 中的 `init_database()` 函数添加新表的创建语句和相关操作函数：

```python
# 在 init_database 函数中添加新表创建
def init_database():
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        # 现有表创建...
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS new_table (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        conn.commit()
    finally:
        conn.close()

# 添加新表的操作函数
def add_new_record(name):
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        cursor.execute('INSERT INTO new_table (name) VALUES (?)', (name,))
        conn.commit()
    finally:
        conn.close()
```

#### 5.1.2 扩展现有表
修改现有表结构，添加新字段：

```python
def init_database():
    conn = get_db_connection()
    cursor = conn.cursor()
    try:
        # 添加新字段到现有表
        try:
            cursor.execute('ALTER TABLE users ADD COLUMN new_field TEXT')
            conn.commit()
        except Exception as e:
            print(f"字段已存在或添加失败: {e}")
    finally:
        conn.close()
```

### 5.2 功能扩展

#### 5.2.1 添加新页面
1. 在 `miniprogram/pages` 目录下创建新页面文件夹
2. 在 `app.json` 中注册新页面
3. 编写页面的 .wxml、.wxss、.js 和 .json 文件
4. 在后端添加相应的 API 接口

#### 5.2.2 扩展打卡逻辑
在 `student.py` 中修改打卡逻辑，实际项目中打卡逻辑是通过向punch_records表插入记录实现的：

```python
@student_function.route('/punch', methods=['POST'])
def submit_punch():
    """提交打卡记录"""
    try:
        data = request.get_json()
        username = data.get('username', '')
        user_id = data.get('user_id', '')
        
        # 获取当前日期
        now = datetime.now()
        today = now.strftime('%Y-%m-%d')
        
        # 连接数据库
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # 检查今天是否已经打卡
        cursor.execute(
            "SELECT id FROM punch_records WHERE user_id = ? AND punch_date = ?",
            (user_id, today)
        )
        existing_record = cursor.fetchone()
        
        if existing_record:
            conn.close()
            return jsonify({'success': False, 'message': '今日已打卡'}), 400
        
        # 插入打卡记录
        cursor.execute(
            "INSERT INTO punch_records (username, user_id, punch_date) VALUES (?, ?, ?)",
            (username, user_id, today)
        )
        
        conn.commit()
        conn.close()
        
        return jsonify({'success': True, 'message': '打卡成功'}), 200
        
    except Exception as e:
        return jsonify({'success': False, 'message': f'打卡失败: {str(e)}'}), 500
```

#### 5.2.3 添加请假功能
1. **数据库扩展**：
   - 在 `punch_records` 表中添加了 `leave_start_date`、`leave_end_date` 和 `leave_status` 字段，用于存储请假信息
   - 请假状态包括：pending（待审批）、approved（已批准）、rejected（已拒绝）

2. **API扩展**：
   - 学生端：`/api/student/apply-leave`（提交请假申请）、`/api/student/leave-records`（获取请假记录）
   - 教师端：`/api/teacher/leave-applications`（获取待审批请假申请）、`/api/teacher/approve-leave`（审批请假申请）
   - 打卡记录查询接口增加了请假状态的显示

3. **前端扩展**：
   - 添加了 `leave-apply` 页面，用于学生提交请假申请
   - 添加了 `leave-records` 页面，用于学生查看请假记录
   - 在 `auth.js` 中添加了请假相关的API调用函数

#### 5.2.4 添加新角色
1. 在 `database.py` 中扩展用户表，添加新角色类型
2. 在前端页面中添加新角色的页面和功能
3. 在后端添加新角色的业务逻辑

#### 5.2.5 管理员功能开发
1. **后端开发**：
   - 创建 `admin.py` 文件，实现管理员蓝图
   - 添加管理员API：登录、获取用户列表、添加/修改/删除用户
   - 示例代码：
     ```python
     from flask import Blueprint, request, jsonify
     admin_bp = Blueprint('admin', __name__, url_prefix='/api/admin')
     
     @admin_bp.route('/login', methods=['POST'])
     def admin_login():
         # 管理员登录逻辑
         pass
     
     @admin_bp.route('/users', methods=['GET'])
     def get_all_users():
         # 获取所有用户列表
         pass
     ```

2. **Web管理界面开发**：
   - 创建 `admin.html` 单页面应用
   - 实现登录、用户列表展示、添加/编辑/删除用户功能
   - 使用JavaScript进行API调用和页面交互

3. **集成到主应用**：
   - 在 `app.py` 中注册管理员蓝图
   - 添加管理员页面路由
   - 示例代码：
     ```python
     from admin import admin_bp
     app.register_blueprint(admin_bp)
     
     @app.route('/admin')
     def admin_page():
         return send_from_directory('../', 'admin.html')
     ```

### 5.3 API 扩展

实际项目中API是通过蓝图来组织的，例如学生相关API在student.py中使用蓝图：

```python
# 在 student.py 中添加新的 API 接口
@student_function.route('/new_endpoint', methods=['POST'])
def new_endpoint():
    """新的API接口"""
    try:
        data = request.get_json()
        # 业务逻辑处理
        # 返回响应
        return jsonify({'success': True, 'message': '操作成功', 'data': result}), 200
    except Exception as e:
        return jsonify({'success': False, 'message': f'操作失败: {str(e)}'}), 500
```

### 5.4 前端扩展

#### 5.4.1 添加新组件
1. 创建组件文件夹和文件
2. 在需要使用的页面中引入组件
3. 编写组件逻辑和样式

#### 5.4.2 扩展工具函数
在 `miniprogram/utils` 目录下添加新的工具函数文件，如 `utils/new_tool.js`：

```javascript
// 新工具函数
export function newFunction() {
    // 函数逻辑
    return result;
}
```

## 6. 代码规范

### 6.1 后端代码规范
- 函数命名使用 snake_case
- 类命名使用 PascalCase
- 变量命名使用 snake_case
- 每行不超过 120 个字符
- 函数前添加 docstring 说明

### 6.2 前端代码规范
- 函数命名使用 camelCase
- 变量命名使用 camelCase
- 组件命名使用 kebab-case
- 每行不超过 100 个字符
- 关键逻辑添加注释

## 7. 测试指南

### 7.1 后端测试
1. 使用 Postman 或 curl 测试 API 接口
2. 测试数据库操作是否正确
3. 测试边界情况和异常处理

### 7.2 前端测试
1. 在微信开发者工具中测试页面功能
2. 测试不同设备和屏幕尺寸的适配
3. 测试各种用户操作场景

## 8. 部署指南

### 8.1 后端部署
1. 安装 Python 环境
2. 安装依赖：`pip install flask`
3. 运行后端：`python app.py`
4. 可使用 Nginx + Gunicorn 进行生产环境部署

### 8.2 前端部署
1. 在微信开发者工具中上传代码
2. 在微信公众平台提交审核
3. 审核通过后发布上线

## 9. 常见问题

### 9.1 数据库连接问题
- 检查数据库文件路径是否正确
- 检查数据库读写权限

### 9.2 API 调用失败
- 检查请求方法是否正确
- 检查请求参数是否符合要求
- 检查后端服务是否正常运行

### 9.3 小程序页面不显示
- 检查页面是否在 `app.json` 中注册
- 检查页面文件路径是否正确
- 检查网络请求是否成功

## 10. 版本控制

使用 Git 进行版本控制，遵循以下分支策略：
- `master`：主分支，用于发布稳定版本
- `dev`：开发分支，用于集成新功能
- `feature/*`：功能分支，用于开发特定功能
- `bugfix/*`： bug 修复分支，用于修复特定问题

## 11. 贡献指南

1. Fork 本项目
2. 创建功能分支：`git checkout -b feature/your-feature`
3. 提交代码：`git commit -m 'Add some feature'`
4. 推送到分支：`git push origin feature/your-feature`
5. 提交 Pull Request

## 12. 联系方式

如有问题或建议，欢迎提交 Issue 或 Pull Request。

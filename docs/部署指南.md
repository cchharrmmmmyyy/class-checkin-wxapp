# 微信小程序打卡系统 - 部署指南

本指南详细说明如何部署微信小程序打卡系统，包括本地开发环境部署和Linux服务器生产环境部署，确保应用能够正常运行。

## 1. 本地开发环境部署

### 1.1 环境要求
- Python 3.8+（必须）
- Git（用于克隆代码，可选）
- 微信开发者工具（用于小程序开发和测试）

### 1.2 本地环境配置

#### 1.2.1 安装Python 3.8+

**Windows系统**：
1. 从 [Python官网](https://www.python.org/downloads/) 下载最新版本的Python安装包
2. 运行安装程序，勾选"Add Python to PATH"选项
3. 完成安装后，打开命令提示符，输入 `python --version` 验证安装

**macOS系统**：
```bash
# 使用Homebrew安装Python
brew install python

# 验证安装
python3 --version
```

**Linux系统**：
```bash
# Ubuntu/Debian
apt update
apt install -y python3 python3-pip

# CentOS/RHEL
yum install -y python3 python3-pip

# 验证安装
python3 --version
```

#### 1.2.2 获取项目代码

**通过Git克隆**：
```bash
# 克隆项目代码到本地
git clone https://your-repo-url.git wechat-punch-system

# 进入项目目录
cd wechat-punch-system
```

**手动下载**：
1. 从Git仓库下载项目代码压缩包
2. 解压到本地目录
3. 进入项目目录

### 1.3 安装依赖

**Windows系统**：
```cmd
# 进入项目根目录
cd wechat-punch-system

# 安装依赖
pip install flask flask-cors
```

**macOS/Linux系统**：
```bash
# 进入项目根目录
cd wechat-punch-system

# 安装依赖
pip3 install flask flask-cors
```

### 1.4 数据库初始化

**Windows系统**：
```cmd
# 进入backend目录
cd backend

# 初始化数据库
python database.py
```

**macOS/Linux系统**：
```bash
# 进入backend目录
cd backend

# 初始化数据库
python3 database.py
```

### 1.5 本地开发模式启动

**Windows系统**：
```cmd
# 确保在backend目录下
cd backend

# 启动开发服务器
python app.py
```

**macOS/Linux系统**：
```bash
# 确保在backend目录下
cd backend

# 启动开发服务器
python3 app.py
```

服务默认运行在 `http://127.0.0.1:5000`

### 1.6 本地测试验证

1. **访问管理员界面**：在浏览器中访问 `http://127.0.0.1:5000/admin`
2. **测试API接口**：使用Postman或curl测试登录接口
   ```bash
   curl -X POST -H "Content-Type: application/json" -d '{"username":"admin","password":"admin123"}' http://127.0.0.1:5000/api/admin/login
   ```
3. **小程序连接测试**：在微信开发者工具中修改API地址为 `http://127.0.0.1:5000`，测试小程序功能

## 2. Linux服务器生产环境部署

### 2.1 服务器硬件要求
- CPU: 至少1核
- 内存: 至少512MB
- 存储空间: 至少1GB

### 2.2 服务器操作系统要求
- Linux系统（推荐Ubuntu 20.04或CentOS 7+）

### 2.3 服务器软件环境
- Python 3.8+（必须）
- Git（用于克隆代码）
- Nginx或Apache（可选，用于反向代理）

### 2.4 服务器环境配置

#### 2.4.1 系统更新与基础工具安装

**Ubuntu/Debian系统**：
```bash
# 更新系统包
apt update && apt upgrade -y

# 安装基础工具
apt install -y git vim
```

**CentOS/RHEL系统**：
```bash
# 更新系统包
yum update -y && yum upgrade -y

# 安装基础工具
yum install -y git vim
```

#### 2.4.2 安装Python 3.8+

**Ubuntu/Debian系统**：
```bash
# 安装Python 3.8和pip
apt install -y python3.8 python3.8-venv python3-pip

# 验证安装
python3 --version
pip3 --version

# 升级pip到最新版本
pip3 install --upgrade pip
```

**CentOS/RHEL系统**：
```bash
# 安装EPEL仓库
yum install -y epel-release

# 安装Python 3.8和pip
yum install -y python38 python38-pip

# 验证安装
python3.8 --version
pip3.8 --version

# 升级pip到最新版本
pip3.8 install --upgrade pip
```

#### 2.4.3 安装Git
```bash
# Ubuntu/Debian
apt install -y git

# CentOS/RHEL
yum install -y git

# 验证安装
git --version
```

### 2.5 服务器代码部署

#### 2.5.1 创建项目目录
```bash
# 创建项目根目录
mkdir -p /opt/punch-system
cd /opt/punch-system
```

#### 2.5.2 克隆代码
```bash
# 克隆项目代码到服务器
# 注意：请替换为您的实际Git仓库地址
git clone https://your-repo-url.git .
```

#### 2.5.3 检查代码结构
```bash
# 确认代码结构正确
ls -la

# 预期输出应包含以下文件/目录
# backend/  docs/  miniprogram/  README.md  requirements.txt
```

### 2.6 服务器依赖安装

#### 2.6.1 创建虚拟环境
```bash
# 在项目根目录创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 验证虚拟环境已激活
which python
# 输出应指向虚拟环境中的Python
```

#### 2.6.2 安装依赖包
```bash
# 安装requirements.txt中的所有依赖
pip install -r requirements.txt
```

### 2.7 服务器数据库配置

#### 2.7.1 数据库路径说明

当前项目的数据库路径已经统一配置为绝对路径，确保应用在任何目录下运行都能找到正确的数据库文件。

- 数据库文件位置：`backend/user.db`
- 配置方式：`database.py` 中使用 `os.path` 模块自动获取当前文件所在目录，构建绝对路径
- 无需手动修改数据库路径配置

#### 2.7.2 初始化数据库
```bash
# 进入backend目录
cd backend

# 初始化数据库
python database.py

# 退出backend目录
cd ..
```

#### 2.7.3 简单数据库备份（可选）

对于小系统，建议定期手动备份数据库：

```bash
# 创建备份目录
mkdir -p /opt/punch-system/backup

# 手动备份数据库
cp /opt/punch-system/backend/user.db /opt/punch-system/backup/user.db.$(date +%Y%m%d)
```

### 2.8 服务器应用启动

#### 2.8.1 生产模式启动（推荐）

使用Gunicorn作为WSGI服务器，配合systemd进行管理。

##### 安装Gunicorn
```bash
# 确保虚拟环境已激活
source venv/bin/activate
pip install gunicorn
```

##### 创建Gunicorn配置文件
```bash
# 在backend目录创建gunicorn.conf.py
vim backend/gunicorn.conf.py
```

添加以下内容：
```python
# gunicorn配置文件
workers = 2          # 进程数
bind = '0.0.0.0:5000'  # 绑定地址和端口
timeout = 60         # 超时时间
worker_class = 'sync'  # 工作模式
errorlog = 'gunicorn.error.log'  # 错误日志文件
accesslog = 'gunicorn.access.log'  # 访问日志文件
loglevel = 'info'    # 日志级别
```

##### 创建systemd服务文件
```bash
# 创建systemd服务文件
vim /etc/systemd/system/punch-system.service
```

添加以下内容：
```ini
[Unit]
Description=WeChat Punch System Backend
After=network.target

[Service]
User=root
WorkingDirectory=/opt/punch-system/backend
Environment="PATH=/opt/punch-system/venv/bin"
ExecStart=/opt/punch-system/venv/bin/gunicorn -c gunicorn.conf.py app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

##### 启动并启用服务
```bash
# 重新加载systemd配置
systemctl daemon-reload

# 启动服务
systemctl start punch-system

# 启用服务，使其开机自启
systemctl enable punch-system

# 查看服务状态
systemctl status punch-system

# 查看服务日志
journalctl -u punch-system -f
```

#### 2.8.2 使用Nginx作为反向代理（可选）

对于小系统，直接使用Gunicorn提供服务即可。如果需要使用域名或HTTPS，可以配置Nginx。

**简单Nginx配置**：

```bash
# Ubuntu/Debian安装Nginx
apt install -y nginx

# CentOS/RHEL安装Nginx
yum install -y nginx

# 创建简单配置文件
cat > /etc/nginx/conf.d/punch-system.conf << EOF
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或IP

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
    }
}
EOF

# 测试并启动Nginx
nginx -t
systemctl start nginx
systemctl enable nginx
```

## 3. 应用管理

### 3.1 本地开发环境管理

**停止服务**：
- 在命令窗口中按 `Ctrl+C` 停止开发服务器

**重启服务**：
- 关闭当前服务后，重新执行启动命令

### 3.2 服务器环境管理

#### 3.2.1 查看日志
```bash
# 查看应用日志
journalctl -u punch-system -f

# 查看Gunicorn日志
cd /opt/punch-system/backend
cat gunicorn.error.log
cat gunicorn.access.log
```

#### 3.2.2 重启应用
```bash
# 重启后端服务
systemctl restart punch-system
```

#### 3.2.3 更新代码
```bash
# 进入项目根目录
cd /opt/punch-system

# 激活虚拟环境
source venv/bin/activate

# 拉取最新代码
git pull

# 安装新依赖（如果有）
pip install -r requirements.txt

# 重启应用
systemctl restart punch-system
```

## 4. 访问应用

### 4.1 本地开发环境访问
- **管理员界面**：`http://127.0.0.1:5000/admin`
- **API接口**：`http://127.0.0.1:5000/api/`
- **小程序连接**：在微信开发者工具中配置API地址为 `http://127.0.0.1:5000`

### 4.2 服务器环境访问
- **直接访问**：`http://服务器IP:5000`
- **通过域名访问**：`http://your-domain.com`（配置Nginx反向代理后）
- **管理员界面**：`http://服务器IP:5000/admin` 或 `http://your-domain.com/admin`

## 5. 常见问题及解决方案

### 5.1 应用无法启动
- 检查端口是否被占用：`netstat -tuln | grep 5000`
- 查看日志：`journalctl -u punch-system -n 50`（服务器环境）
- 检查数据库路径是否正确
- 检查依赖是否安装完整

### 5.2 数据库连接失败
- 检查数据库文件权限：`chmod 664 /opt/punch-system/backend/user.db`
- 确保数据库文件存在：`ls -la /opt/punch-system/backend/user.db`
- 检查数据库路径配置是否正确

### 5.3 访问被拒绝
- 检查防火墙设置：`ufw status`（Ubuntu）或 `firewall-cmd --list-ports`（CentOS）
- 确保端口已开放：`ufw allow 5000`（Ubuntu）或 `firewall-cmd --permanent --add-port=5000/tcp`（CentOS）
- 检查SELinux状态（CentOS）：`getenforce`，如为Enforcing，可临时关闭：`setenforce 0`

### 5.4 虚拟环境问题
- 确保在正确的目录激活虚拟环境
- 检查依赖是否正确安装：`pip list`

## 6. 安全建议

1. **设置强密码**：修改默认的管理员密码
2. **定期备份数据库**：使用 `cp /opt/punch-system/backend/user.db /opt/punch-system/backend/user.db.backup.$(date +%Y%m%d)` 手动备份
3. **更新依赖**：定期运行 `pip install --upgrade -r requirements.txt`
4. **定期更新系统**：`apt update && apt upgrade -y`（Ubuntu）或 `yum update -y`（CentOS）

## 7. 部署完成验证

### 7.1 本地开发环境验证
1. **检查服务状态**：在浏览器中访问 `http://127.0.0.1:5000`
2. **测试管理员登录**：访问 `http://127.0.0.1:5000/admin`，使用默认账号密码登录

### 7.2 服务器环境验证
1. **检查服务状态**：`systemctl status punch-system`
2. **访问应用**：在浏览器中访问 `http://服务器IP:5000`
3. **测试管理员登录**：访问 `http://服务器IP:5000/admin`，使用默认账号密码登录

## 8. 后续维护

1. **定期备份数据库**：每周手动备份一次数据库
2. **定期更新代码**：当有新功能或bug修复时，拉取最新代码并重启服务
3. **检查日志**：当应用出现问题时，查看日志文件 `gunicorn.error.log`
4. **定期清理日志**：删除过旧的日志文件，释放磁盘空间

## 9. 小程序端配置

### 9.1 修改API地址

1. 打开微信开发者工具，导入 `miniprogram` 目录
2. 编辑 `miniprogram/utils/auth.js` 文件
3. 将API地址修改为部署的后端服务地址
   ```javascript
   // 本地开发环境
   const BASE_URL = 'http://127.0.0.1:5000';
   
   // 服务器生产环境
   // const BASE_URL = 'http://your-domain.com';
   ```

### 9.2 小程序编译与预览

1. 在微信开发者工具中编译项目
2. 使用微信扫码预览
3. 测试各项功能是否正常

### 9.3 小程序发布

1. 确保所有功能测试通过
2. 填写小程序版本信息
3. 提交审核
4. 审核通过后发布上线

---

**部署完成！** 您的微信小程序打卡系统已经成功部署，可以正常访问和使用了。如果遇到任何问题，请参考本指南的常见问题部分或查看相关日志。
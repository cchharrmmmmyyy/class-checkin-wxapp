# Flask应用部署指南

本指南详细说明如何将本项目部署到服务器上，确保应用能够正常运行。

## 1. 服务器环境准备

### 1.1 硬件要求
- CPU: 至少1核
- 内存: 至少512MB
- 存储空间: 至少1GB

### 1.2 操作系统要求
- Linux系统（推荐Ubuntu 20.04或CentOS 7+）
- Windows Server 2016+（不推荐）

### 1.3 软件环境
- Python 3.8+（必须）
- Git（用于克隆代码）
- 任意HTTP服务器（如Nginx或Apache，可选，用于反向代理）

## 2. 服务器环境配置

### 2.1 安装Python 3.8+

#### Ubuntu/Debian系统
```bash
# 更新包列表
apt update

# 安装Python 3.8和pip
apt install -y python3.8 python3.8-venv python3-pip

# 验证安装
python3 --version
pip3 --version
```

#### CentOS/RHEL系统
```bash
# 安装EPEL仓库
yum install -y epel-release

# 安装Python 3.8和pip
yum install -y python38 python38-pip

# 验证安装
python3.8 --version
pip3.8 --version
```

### 2.2 安装Git
```bash
# Ubuntu/Debian
apt install -y git

# CentOS/RHEL
yum install -y git

# 验证安装
git --version
```

## 3. 代码部署

### 3.1 创建项目目录
```bash
# 创建项目根目录
mkdir -p /opt/flask-app
cd /opt/flask-app
```

### 3.2 克隆代码
```bash
# 克隆项目代码
# 注意：请替换为您的实际Git仓库地址
git clone https://your-repo-url.git .
```

### 3.3 检查代码结构
```bash
# 确认代码结构正确
ls -la

# 预期输出应包含以下文件/目录
# backend/  docs/  miniprogram/  README.md  requirements.txt  user.db
```

## 4. 安装依赖

### 4.1 创建虚拟环境
```bash
# 在项目根目录创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 验证虚拟环境已激活
which python
# 输出应指向虚拟环境中的Python
```

### 4.2 安装依赖包
```bash
# 安装requirements.txt中的所有依赖
pip install -r requirements.txt
```

## 5. 数据库配置

### 5.1 统一数据库路径（重要）

当前项目的数据库路径配置可能存在不一致的情况，需要统一修改为绝对路径，确保应用在任何目录下运行都能找到正确的数据库文件。

#### 修改database.py
```bash
# 编辑database.py文件
vim backend/database.py
```

将以下代码：
```python
# 数据库文件路径
DATABASE_FILE = 'user.db'
```

修改为：
```python
import os

# 获取项目根目录
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
# 数据库文件路径
DATABASE_FILE = os.path.join(PROJECT_ROOT, 'user.db')
```

#### 修改update_db.py
```bash
# 编辑update_db.py文件
vim backend/update_db.py
```

将以下代码：
```python
# 数据库文件路径
DATABASE_FILE = '../user.db'
```

修改为：
```python
import os

# 获取项目根目录
PROJECT_ROOT = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
# 数据库文件路径
DATABASE_FILE = os.path.join(PROJECT_ROOT, 'user.db')
```

### 5.2 初始化数据库
```bash
# 进入backend目录
cd backend

# 初始化数据库
python database.py

# 退出backend目录
cd ..
```

## 6. 应用启动

### 6.1 开发模式启动（仅用于测试）
```bash
# 激活虚拟环境
source venv/bin/activate

# 进入backend目录
cd backend

# 启动应用
python app.py

# 按Ctrl+C停止应用
```

### 6.2 生产模式启动（推荐）

使用Gunicorn作为WSGI服务器，配合systemd进行管理。

#### 安装Gunicorn
```bash
# 确保虚拟环境已激活
pip install gunicorn
```

#### 创建Gunicorn配置文件
```bash
# 在backend目录创建gunicorn.conf.py
vim backend/gunicorn.conf.py
```

添加以下内容：
```python
# gunicorn配置文件
workers = 2          # 进程数
bind = '0.0.0.0:5000'  # 绑定地址和端口
timeout = 60         # 超时时间
worker_class = 'sync'  # 工作模式
errorlog = 'gunicorn.error.log'  # 错误日志文件
accesslog = 'gunicorn.access.log'  # 访问日志文件
loglevel = 'info'    # 日志级别
```

#### 创建systemd服务文件
```bash
# 创建systemd服务文件
vim /etc/systemd/system/flask-app.service
```

添加以下内容：
```ini
[Unit]
Description=Flask Application
After=network.target

[Service]
User=root
WorkingDirectory=/opt/flask-app/backend
Environment="PATH=/opt/flask-app/venv/bin"
ExecStart=/opt/flask-app/venv/bin/gunicorn -c gunicorn.conf.py app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

#### 启动并启用服务
```bash
# 重新加载systemd配置
systemctl daemon-reload

# 启动服务
systemctl start flask-app

# 启用服务，使其开机自启
systemctl enable flask-app

# 查看服务状态
systemctl status flask-app
```

## 7. 访问应用

### 7.1 直接访问
```bash
# 应用已启动在5000端口，可以通过以下地址访问
# http://服务器IP:5000

# 测试管理员登录页面
# http://服务器IP:5000/admin
```

### 7.2 使用Nginx作为反向代理（可选）

安装并配置Nginx，将请求转发到Gunicorn。

#### 安装Nginx
```bash
# Ubuntu/Debian
apt install -y nginx

# CentOS/RHEL
yum install -y nginx

# 启动Nginx
systemctl start nginx
systemctl enable nginx
```

#### 配置Nginx
```bash
# 创建Nginx配置文件
vim /etc/nginx/conf.d/flask-app.conf
```

添加以下内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或IP

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

#### 测试并重启Nginx
```bash
# 测试Nginx配置
nginx -t

# 重启Nginx
systemctl restart nginx
```

## 8. 应用管理

### 8.1 查看日志
```bash
# 查看应用日志
journalctl -u flask-app -f

# 查看Gunicorn日志
cd /opt/flask-app/backend
cat gunicorn.error.log
cat gunicorn.access.log
```

### 8.2 重启应用
```bash
# 重启Flask应用
systemctl restart flask-app
```

### 8.3 更新代码
```bash
# 进入项目根目录
cd /opt/flask-app

# 激活虚拟环境
source venv/bin/activate

# 拉取最新代码
git pull

# 安装新依赖（如果有）
pip install -r requirements.txt

# 重启应用
systemctl restart flask-app
```

## 9. 常见问题及解决方案

### 9.1 应用无法启动
- 检查端口是否被占用：`netstat -tuln | grep 5000`
- 查看日志：`journalctl -u flask-app -n 50`
- 检查数据库路径是否正确

### 9.2 数据库连接失败
- 检查数据库文件权限：`chmod 664 /opt/flask-app/user.db`
- 确保数据库文件存在：`ls -la /opt/flask-app/user.db`
- 检查数据库路径配置是否正确

### 9.3 访问被拒绝
- 检查防火墙设置：`ufw status`（Ubuntu）或 `firewall-cmd --list-ports`（CentOS）
- 确保端口已开放：`ufw allow 5000`（Ubuntu）或 `firewall-cmd --permanent --add-port=5000/tcp`（CentOS）

### 9.4 虚拟环境问题
- 确保在正确的目录激活虚拟环境
- 检查依赖是否正确安装：`pip list`

## 10. 安全建议

1. **不要在生产环境使用开发模式**：确保使用Gunicorn等WSGI服务器
2. **设置强密码**：修改默认的管理员密码
3. **定期备份数据库**：`cp /opt/flask-app/user.db /opt/flask-app/user.db.backup.$(date +%Y%m%d)`
4. **更新依赖**：定期运行 `pip install --upgrade -r requirements.txt`
5. **限制访问**：使用防火墙或Nginx限制只允许特定IP访问
6. **启用HTTPS**：使用Let's Encrypt等工具为Nginx配置HTTPS

## 11. 部署完成验证

1. **检查应用状态**：`systemctl status flask-app`
2. **访问应用**：在浏览器中访问 `http://服务器IP:5000`
3. **测试API**：使用curl测试登录接口
   ```bash
   curl -X POST -H "Content-Type: application/json" -d '{"username":"admin","password":"admin123"}' http://服务器IP:5000/api/admin/login
   ```
4. **检查数据库**：确保能正常连接和查询数据

## 12. 后续维护

1. **定期备份数据库**
2. **监控应用日志**
3. **定期更新代码和依赖**
4. **监控服务器资源使用情况**
5. **及时处理安全漏洞**

---

**部署完成！** 您的Flask应用现在已经成功部署到服务器上，可以正常访问和使用了。如果遇到任何问题，请参考本指南的常见问题部分或查看相关日志。